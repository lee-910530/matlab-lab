clc;
close all;
clear all;
%..........
%.......data........
h = 0.05;
fin = 1000;
tn = 0:h:fin

G_pat3(1) = 70;
X_pat3(1) = 0;
I_pat3(1) = 7;
U(1) = 0;

G_pat3_d = zeros(1,fin/h+1);
G_pat3_d = zeros(1,fin/h+1);
U = zeros(1,fin/h+1);

G_normal(1) = 70;
X_normal(1) = 0;
I_normal(1) = 7;


w1 = 1;
w2 = 1;
w3 = 1;
w4 = 1;
w5 = 1;
w6 = 1;
w7 = 1;
w8 = 1;
w9 = 1;
ETA = 0.5;

x = fin/h;
%..........glucose concentration-input1...........
x1 = 0:0.02:400;
NB = trapezoid_up_wave(x1,50,70);
NS = triangle_wave(x1,50,70,75);
NOM = triangle_wave(x1,70,75,80);
PS = triangle_wave(x1,75,80,150);
PM = triangle_wave(x1,75,150,225);
PB = triangle_wave(x1,150,225,300);
PL = trapezoid_down_wave(x1,225,300);

% figure('name','glucose concentration-input1');
% plot(x1,NB,"b",x1,NS,"g",x1,NOM,"r",x1,PS,"c",x1,PL,"k");
% hold on;
% plot(x1,PM,"Color","#E020F0")
% hold on;
% plot(x1,PB,"Color","#E09010")
% xlim([40,400])
% title('glucose concentration-input1')
% xlabel("glucose concentration(mg/dl)")

%..........glucose deviation-input2...........
x2 = -20:0.002:20;
neg = triangle_wave(x2,-20,-20,0);
zero = triangle_wave(x2,-1,0,1);
pos = triangle_wave(x2,0,20,20);

% figure('name','glucose deviation-input2');
% plot(x2,neg,"b",x2,zero,"g",x2,pos,"r");
% title('glucose deviation-input2')
% xlabel("glucose deviation(mg/dl)")

%..........insulin infusion rate-output...........
y = -1:0.0005:9;
NB_o = triangle_wave(y,-1,-0.5,-0.2);
NS_o = triangle_wave(y,-0.4,-0.2,0.2);
Z_o = triangle_wave(y,-0.2,0.2,0.5);
PS_o = triangle_wave(y,0.2,0.5,2);
PM_o = triangle_wave(y,0.6,2,4);
PB_o = triangle_wave(y,2,4,6);
PL_o = triangle_wave(y,4,6,8);

figure('name','insulin infusion rate-output');
plot(y,NB_o,"b",y,NS_o,"g",y,Z_o,"r",y,PS_o,"c",y,PL_o,"k");
hold on;
plot(y,PM_o,"Color","#E020F0")
hold on;
plot(y,PB_o,"Color","#E09010")
title("insulin infusion rate-output")
xlabel("insulin infusion rate(microU/min/mg)")

%.............patient3................
num = 1;
for i = tn
    G_pat3_d(num) = G_p3(i,G_pat3(num),X_pat3(num),I_pat3(num));

    q1 = round(G_pat3(num)/0.02) + 1;
%     q1 = G_pat3(num);
    q2 = round((G_pat3_d(num)+20)/0.002) + 1;

    w1 = min(PL(q1),neg(q2));  %PL
%     if q1 < 225
%         mu1 = 0;
%     elseif q1 >= 300
%         mu1 = 1;
%     elseif q1 >= 225 && q1 < 300
%         mu1 = 1/(300 - 225) * (i - 225);
%     end
    w2 = min(PL(q1),zero(q2)); %PL
    w3 = min(PL(q1),pos(q2));  %PL
    w4 = min(PB(q1),neg(q2));  %PB
    w5 = min(PB(q1),zero(q2)); %PB
    w6 = min(PB(q1),pos(q2));  %PL
    w7 = min(PM(q1),neg(q2));  %PM
    w8 = min(PM(q1),zero(q2)); %PM
    w9 = min(PM(q1),pos(q2));  %PM
    w10 = min(PS(q1),neg(q2)); %PS
    w11 = min(PS(q1),zero(q2));%PS
    w12 = min(PS(q1),pos(q2)); %PS
    w13 = min(NOM(q1),neg(q2));%Z
    w14 = min(NOM(q1),zero(q2));%Z
    w15 = min(NOM(q1),pos(q2)); %Z
    w16 = min(NS(q1),neg(q2));  %NB
    w17 = min(NS(q1),zero(q2)); %NS
    w18 = min(NS(q1),pos(q2));  %NS
    w19 = min(NB(q1),neg(q2));  %NB
    w20 = min(NB(q1),zero(q2)); %NB
    w21 = min(NB(q1),pos(q2));  %NB

    PL_o = max([w1,w2,w3,w6]);
    PB_o = max([w4,w5]);
    PM_o = max([w7,w8,w9]);
    PS_o = max([w10,w11,w12]);
    Z_o = max([w13,w14,w15]);
    NS_o = max([w17,w18]);
    NB_o = max([w16,w19,w20,w21]);

    U(num) = (NB_o*(-0.5)+NS_o*(-0.2)+Z_o*0.2+PS_o*0.5+PM_o*2+PB_o*4+PL_o*6) / (NB_o+NS_o+Z_o+PS_o+PM_o+PB_o+PL_o);


    k1 = G_p3(i,G_pat3(num),X_pat3(num),I_pat3(num));
    l1 = X_p3(i,G_pat3(num),X_pat3(num),I_pat3(num));
    j1 = I_p3(i,G_pat3(num),X_pat3(num),I_pat3(num),U(num));

    k2 = G_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    l2 = X_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    j2 = I_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2,U(num));

    k3 = G_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    l3 = X_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    j3 = I_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2,U(num));
    
    k4 = G_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    l4 = X_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    j4 = I_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3,U(num));
    
    if num < x +1
        G_pat3(num+1) = G_pat3(num) + h*(k1+2*k2+2*k3+k4)/6;
        X_pat3(num+1) = X_pat3(num) + h*(l1+2*l2+2*l3+l4)/6;
        I_pat3(num+1) = I_pat3(num) + h*(j1+2*j2+2*j3+j4)/6;
    end
       num = num +1;
end
figure(6)
plot(tn,U)
title('u(t)')
ylabel('insulin infusion')
xlabel('time(min)')

figure(7)
plot(tn,G_pat3_d)
title('patient3 dG(t)/dt')
xlabel('time(min)')

figure(8)
plot(tn,G_pat3)
title('patient3 G(t)')
xlabel('time(min)')

figure(9)
plot(tn,I_pat3)
title('patient3 I(t)')
xlabel('time(min)')
%.............normal.....
%.............normal................
% num = 1;
% for i = tn
%     k1 = G_no(i,G_normal(num),X_normal(num),I_normal(num));
%     l1 = X_no(i,G_normal(num),X_normal(num),I_normal(num));
%     j1 = I_no(i,G_normal(num),X_normal(num),I_normal(num),0);
% 
%     k2 = G_no(i + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2);
%     l2 = X_no(i + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2);
%     j2 = I_no(i + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2,0);
% 
%     k3 = G_no(i + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2);
%     l3 = X_no(i + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2);
%     j3 = I_no(i + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2,0);
%     
%     k4 = G_no(i + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3);
%     l4 = X_no(i + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3);
%     j4 = I_no(i + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3,0);
%     
%     if num <= x
%         G_normal(num+1) = G_normal(num) + h*(k1+2*k2+2*k3+k4)/6;
%         X_normal(num+1) = X_normal(num) + h*(l1+2*l2+2*l3+l4)/6;
%         I_normal(num+1) = I_normal(num) + h*(j1+2*j2+2*j3+j4)/6;
%     end
% 
%     num = num + 1;
% end
%...........................

%.............patient3................
num = 1;
for i = tn
    k1 = G_p3(i,G_pat3(num),X_pat3(num),I_pat3(num));
    l1 = X_p3(i,G_pat3(num),X_pat3(num),I_pat3(num));
    j1 = I_p3(i,G_pat3(num),X_pat3(num),I_pat3(num),U(num));

    k2 = G_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    l2 = X_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    j2 = I_p3(i + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2,U(num));

    k3 = G_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    l3 = X_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    j3 = I_p3(i + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2,U(num));
    
    k4 = G_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    l4 = X_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    j4 = I_p3(i + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3,U(num));
    
    if num < x +1
        G_pat3(num+1) = G_pat3(num) + h*(k1+2*k2+2*k3+k4)/6;
        X_pat3(num+1) = X_pat3(num) + h*(l1+2*l2+2*l3+l4)/6;
        I_pat3(num+1) = I_pat3(num) + h*(j1+2*j2+2*j3+j4)/6;
    end
 num = num + 1;
end

figure(12)
plot(tn,G_pat3)
title('new patient3 G(t)')
xlabel('time(min)')

%..........patient3..........
function g_p3 = G_p3(t,G,X,I)
    w = t-360;
    w(w<0) = inf;
    g_p3 = -0*(G-70)-X*G + 1.7*exp(-0.03*t)+ 1.7*exp(-0.03*w);
end

function x_p3 = X_p3(t,G,X,I)
    x_p3 = -0.02*X + 5.3*10^-6*(I-7);
end

function i_p3 = I_p3(t,G,X,I,u)
    i_p3 = -0.3*(I-7) + u;
end

%..........normal..........
function g_no = G_no(t,G,X,I)
    w = t-360;
    w(w<0) = inf;
    g_no = -0.0317*(G-70)-X*G + 1.7*exp(-0.03*t)+ 1.7*exp(-0.03*w);
end

function x_no = X_no(t,G,X,I)
    x_no = -0.0123*X + 4.92*10^-6*(I-7);
end

function i_no = I_no(t,G,X,I,u)
    if G-79.0353 > 0
        x = G-79.0353;
    else 
        x = 0;
    end
    i_no = -0.2659*(I-7) + 0.0039*x*t + u;
end

%..........function...........
function trap = trapezoid_up_wave(t,start,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            trap(num) = 1;
        elseif i >= fin
            trap(num) = 0;
        elseif i >= start && i < fin
            trap(num) = 1/(start - fin) * (i - fin);
        end
    end
end

function trap = trapezoid_down_wave(t,start,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            trap(num) = 0;
        elseif i >= fin
            trap(num) = 1;
        elseif i >= start && i < fin
            trap(num) = 1/(fin - start) * (i - start);
        end
    end
end

function tri = triangle_wave(t,start,middle,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            tri(num) = 0;
        elseif i >= fin
            tri(num) = 0;
        elseif i >= start && i < middle
            tri(num) = 1/(middle-start)*(i-start);
        else 
            tri(num) = 1/(middle-fin)*(i-fin);
        end
    end
end
