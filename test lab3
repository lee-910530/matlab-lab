clc;
clf;
clear all;
%.......data........
h = 0.05;
fin = 1000;
tn = 0:h:fin;

% G_pat3(1) = 220;
% X_pat3(1) = 0;
% I_pat3(1) = 50;
I3 = zeros(1,fin/h+1);
X3 = zeros(1,fin/h+1);
G3 = zeros(1,fin/h+1);

% G_normal(1) = 291.2;
% X_normal(1) = 0;
% I_normal(1) = 364.8;
In = zeros(1,fin/h+1);
Xn = zeros(1,fin/h+1);
Gn = zeros(1,fin/h+1);

G_pat3(1) = 70;
X_pat3(1) = 0;
I_pat3(1) = 50;

G_normal(1) = 70;
X_normal(1) = 0;
I_normal(1) = 364.8;
%.......runge kutta patient........
x = fin/h;

num = 1;
for i = tn
    k1 = G_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));
    l1 = X_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));
    j1 = I_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num),0);

    k2 = G_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    l2 = X_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
    j2 = I_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2,0);

    k3 = G_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    l3 = X_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
    j3 = I_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2,0);
    
    k4 = G_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    l4 = X_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
    j4 = I_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3,0);

    G_dev_pat3(num) = G_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));

    if num <= x
        G_pat3(num+1) = G_pat3(num) + h*(k1+2*k2+2*k3+k4)/6;
        X_pat3(num+1) = X_pat3(num) + h*(l1+2*l2+2*l3+l4)/6;
        I_pat3(num+1) = I_pat3(num) + h*(j1+2*j2+2*j3+j4)/6;
    
        num = num + 1;
    end
end
%.......runge kutta normal........
num = 1;
for i = tn
    k1 = G_no(tn(num),G_normal(num),X_normal(num),I_normal(num));
    l1 = X_no(tn(num),G_normal(num),X_normal(num),I_normal(num));
    j1 = I_no(tn(num),G_normal(num),X_normal(num),I_normal(num),0);

    k2 = G_no(tn(num) + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2);
    l2 = X_no(tn(num) + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2);
    j2 = I_no(tn(num) + h/2,G_normal(num) + h*k1/2,X_normal(num) + h*l1/2,I_normal(num) + h*j1/2,0);

    k3 = G_no(tn(num) + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2);
    l3 = X_no(tn(num) + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2);
    j3 = I_no(tn(num) + h/2,G_normal(num) + h*k2/2,X_normal(num) + h*l2/2,I_normal(num) + h*j2/2,0);
    
    k4 = G_no(tn(num) + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3);
    l4 = X_no(tn(num) + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3);
    j4 = I_no(tn(num) + h,G_normal(num) + h*k3,X_normal(num) + h*l3,I_normal(num) + h*j3,0);

    if num <= x
        G_normal(num+1) = G_normal(num) + h*(k1+2*k2+2*k3+k4)/6;
        X_normal(num+1) = X_normal(num) + h*(l1+2*l2+2*l3+l4)/6;
        I_normal(num+1) = I_normal(num) + h*(j1+2*j2+2*j3+j4)/6;
    
        num = num + 1;
    end
end

figure('name','glucose concentration')
plot(tn,G_pat3);
hold on;
plot(tn,G_normal);
hold on;
xlabel('time');
ylabel("glucose concentration(mg/dl)");
legend({'patient3','normal'},'Location','southwest');











%...............................
%..........glucose concentration-input1...........
x1 = 0:0.02:400;
NB = trapezoid_up_wave(x1,50,70);
NS = triangle_wave(x1,50,70,75);
NOM = triangle_wave(x1,70,75,80);
PS = triangle_wave(x1,75,80,150);
PM = triangle_wave(x1,75,150,225);
PB = triangle_wave(x1,150,225,300);
PL = trapezoid_down_wave(x1,225,300);

figure('name','glucose concentration-input1');
plot(x1,NB,"b",x1,NS,"g",x1,NOM,"r",x1,PS,"c",x1,PL,"k");
hold on;
plot(x1,PM,"Color","#E020F0")
hold on;
plot(x1,PB,"Color","#E09010")
xlim([40,400])
title('glucose concentration-input1')
xlabel("glucose concentration(mg/dl)")
%..........glucose deviation-input2...........
x2 = -20:0.002:20;
neg = triangle_wave(x2,-20,-20,0);
zero = triangle_wave(x2,-1,0,1);
pos = triangle_wave(x2,0,20,20);
figure('name','glucose deviation-input2');
plot(x2,neg,"b",x2,zero,"g",x2,pos,"r");
title('glucose deviation-input2')
xlabel("glucose deviation(mg/dl)")
%..........insulin infusion rate-output...........
y = -1:0.0005:9;
NB_o = triangle_wave(y,-1,-0.6,-0.2);
NS_o = triangle_wave(y,-0.4,-0.2,0.2);
Z_o = triangle_wave(y,-0.2,0.2,0.6);
PS_o = triangle_wave(y,0.2,0.6,2);
PM_o = triangle_wave(y,0.6,2,4);
PB_o = triangle_wave(y,2,4,6);
PL_o = triangle_wave(y,4,6,8);
figure('name','insulin infusion rate-output');
plot(y,NB_o,"b",y,NS_o,"g",y,Z_o,"r",y,PS_o,"c",y,PL_o,"k");
hold on;
plot(y,PM_o,"Color","#E020F0")
hold on;
plot(y,PB_o,"Color","#E09010")
title("insulin infusion rate-output")
xlabel("insulin infusion rate(microU/min/mg)")
%..........patient3 FLC u(t)...........
num = 1;
for i = tn
    w1 = round(G_pat3(num)/0.02)+1;
    w2 = round((G_dev_pat3(num)+20)/0.002)+1;

    NB_o = max([min(NB(w1),neg(w2)),min(NB(w1),zero(w2)),min(NB(w1),pos(w2)),min(NS(w1),neg(w2))])
    NS_o = max([min(NS(w1),zero(w2)),min(NS(w1),pos(w2))])
    Z_o = max([min(NOM(w1),neg(w2)),min(NOM(w1),zero(w2)),min(NOM(w1),pos(w2))])
    PS_o = max([min(PS(w1),neg(w2)),min(PS(w1),zero(w2)),min(PS(w1),pos(w2))])
    PM_o = max([min(PM(w1),neg(w2)),min(PM(w1),zero(w2)),min(PM(w1),pos(w2))])
    PB_o = max([min(PB(w1),neg(w2)),min(PB(w1),zero(w2))])
    PL_o = max([min(PL(w1),neg(w2)),min(PL(w1),zero(w2)),min(PL(w1),pos(w2)),min(PB(w1),pos(w2))])

    ut(num) = (NB_o*-0.6+NS_o*-0.2+Z_o*0.2+PS_o*0.6+PM_o*2+PB_o*4+PL_o*6) / (NB_o+NS_o+Z_o+PS_o+PM_o+PB_o+PL_o)
    num = num +1;
end
figure('name','insulin infusion rate');
plot(tn,ut)
% %...................................
% x = fin/h;
% 
% num = 1;
% for i = tn
%     k1 = G_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));
%     l1 = X_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));
%     j1 = I_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num),ut(num));
% 
%     k2 = G_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
%     l2 = X_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2);
%     j2 = I_p3(tn(num) + h/2,G_pat3(num) + h*k1/2,X_pat3(num) + h*l1/2,I_pat3(num) + h*j1/2,ut(num));
% 
%     k3 = G_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
%     l3 = X_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2);
%     j3 = I_p3(tn(num) + h/2,G_pat3(num) + h*k2/2,X_pat3(num) + h*l2/2,I_pat3(num) + h*j2/2,ut(num));
%     
%     k4 = G_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
%     l4 = X_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3);
%     j4 = I_p3(tn(num) + h,G_pat3(num) + h*k3,X_pat3(num) + h*l3,I_pat3(num) + h*j3,ut(num));
% 
%     G_dev_pat3(num) = G_p3(tn(num),G_pat3(num),X_pat3(num),I_pat3(num));
% 
%     if num <= x
%         G_pat3(num+1) = G_pat3(num) + h*(k1+2*k2+2*k3+k4)/6;
%         X_pat3(num+1) = X_pat3(num) + h*(l1+2*l2+2*l3+l4)/6;
%         I_pat3(num+1) = I_pat3(num) + h*(j1+2*j2+2*j3+j4)/6;
%     
%         num = num + 1;
%     end
% end
% 
% figure('name','glucose concentration new')
% plot(tn,G_pat3)
% hold on;
% plot(tn,G_normal)
% xlabel('time')
% ylabel("glucose concentration(mg/dl)")
% legend({'patient3','normal'},'Location','southwest')
% hold on;
%..........patient3..........
function g_p3 = G_p3(t,G,X,I)
    w = t-360;
    w(w<0) = inf;
    g_p3 = -0*(G-70)-X*G + 1.7*exp(-0.03*t)+ 1.7*exp(-0.03*w);
end

function x_p3 = X_p3(t,G,X,I)
    x_p3 = -0.02*X + 5.3*10^-6*(I-7);
end

function i_p3 = I_p3(t,G,X,I,u)
    i_p3 = -0.3*(I-7) + u;
end

%..........normal..........
function g_no = G_no(t,G,X,I)
    w = t-360;
    w(w<0) = inf;
    g_no = -0.0317*(G-70)-X*G + 1.7*exp(-0.03*t) + 1.7*exp(-0.03*w);
end

function x_no = X_no(t,G,X,I)
    x_no = -0.0123*X + 4.92*10^-6*(I-7);
end

function i_no = I_no(t,G,X,I,u)
    if G-79.0353 > 0
        x = G-79.0353;
    else 
        x = 0;
    end
    i_no = -0.2659*(I-7) + 0.0039*x*t + u;
end

%..........function...........
function trap = trapezoid_up_wave(t,start,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            trap(num) = 1;
        elseif i >= fin
            trap(num) = 0;
        elseif i >= start && i < fin
            trap(num) = 1/(start - fin) * (i - fin);
        end
    end
end

function trap = trapezoid_down_wave(t,start,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            trap(num) = 0;
        elseif i >= fin
            trap(num) = 1;
        elseif i >= start && i < fin
            trap(num) = 1/(fin - start) * (i - start);
        end
    end
end

function tri = triangle_wave(t,start,middle,fin)
    num = 0;
    for i = t
        num = num + 1;
        if i < start
            tri(num) = 0;
        elseif i >= fin
            tri(num) = 0;
        elseif i >= start && i < middle
            tri(num) = 1/(middle-start)*(i-start);
        else 
            tri(num) = 1/(middle-fin)*(i-fin);
        end
    end
end
